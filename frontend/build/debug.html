<!DOCTYPE html>
<html>
<head>
    <link rel="manifest" href="/client/public/manifest.json">
    <meta name="theme-color" content="#2c2e3b">
    <link rel="apple-touch-icon" href="/client/public/apple-touch-icon.png">
    <title>Raspberry Pi Monitor - Debug</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { 
            font-family: monospace; 
            background: #000; 
            color: #0f0; 
            margin: 20px;
            line-height: 1.4;
        }
        h1 { 
            color: #0f0; 
            text-align: center; 
        }
        .debug {
            background: #111;
            padding: 20px;
            margin: 20px 0;
            border: 1px solid #0f0;
            border-radius: 5px;
            overflow-y: auto;
            max-height: 600px;
        }
        .error { color: #f00; }
        .success { color: #0f0; }
        .warn { color: #ff0; }
        .info { color: #0ff; }
        button {
            background: #0f0;
            color: #000;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            font-family: monospace;
        }
        button:hover {
            background: #0a0;
        }
    </style>
</head>
<body>
    <h1>üîç Raspberry Pi Monitor - Advanced Debug</h1>
    
    <div>
        <button onclick="testAll()">Run All Tests</button>
        <button onclick="clearLog()">Clear Log</button>
        <button onclick="testDirect()">Test Direct URL</button>
        <button onclick="testRelative()">Test Relative URL</button>
        <button onclick="testXHR()">Test XMLHttpRequest</button>
    </div>
    
    <div id="debug" class="debug">
        <div>===== ADVANCED DEBUG MODE =====</div>
        <div>Starting diagnostics...</div>
    </div>

    <script>
        function log(message, type = 'info') {
            const debugEl = document.getElementById('debug');
            const time = new Date().toLocaleTimeString();
            const className = type;
            debugEl.innerHTML += `<div class="${className}">[${time}] ${message}</div>`;
            debugEl.scrollTop = debugEl.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function clearLog() {
            document.getElementById('debug').innerHTML = '<div>===== LOG CLEARED =====</div>';
        }

        async function testDirect() {
            log('===== TESTING DIRECT URL =====', 'info');
            const url = 'http://192.168.2.130:4999/api/metrics/latest';
            log(`Testing: ${url}`, 'info');
            
            try {
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Cache-Control': 'no-cache'
                    },
                    mode: 'cors',
                    credentials: 'same-origin'
                });
                
                log(`Response Status: ${response.status} ${response.statusText}`, response.ok ? 'success' : 'error');
                log(`Response Headers:`, 'info');
                for (let [key, value] of response.headers) {
                    log(`  ${key}: ${value}`, 'info');
                }
                
                if (response.ok) {
                    const data = await response.json();
                    log(`Success! Data keys: ${Object.keys(data).join(', ')}`, 'success');
                    log(`CPU Usage: ${data.cpu?.[0]?.cpu_usage_percent}%`, 'success');
                }
            } catch (error) {
                log(`Fetch Error: ${error.name}`, 'error');
                log(`Error Message: ${error.message}`, 'error');
                log(`Error Stack: ${error.stack}`, 'error');
            }
        }

        async function testRelative() {
            log('===== TESTING RELATIVE URL =====', 'info');
            const url = '/api/metrics/latest';
            log(`Testing: ${url}`, 'info');
            
            try {
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Cache-Control': 'no-cache'
                    }
                });
                
                log(`Response Status: ${response.status} ${response.statusText}`, response.ok ? 'success' : 'error');
                
                if (response.ok) {
                    const data = await response.json();
                    log(`Success! Data keys: ${Object.keys(data).join(', ')}`, 'success');
                }
            } catch (error) {
                log(`Fetch Error: ${error.name}`, 'error');
                log(`Error Message: ${error.message}`, 'error');
                if (error.cause) {
                    log(`Error Cause: ${JSON.stringify(error.cause)}`, 'error');
                }
            }
        }

        async function testXHR() {
            log('===== TESTING XMLHttpRequest =====', 'info');
            const url = '/api/metrics/latest';
            log(`Testing: ${url}`, 'info');
            
            const xhr = new XMLHttpRequest();
            
            xhr.onreadystatechange = function() {
                log(`ReadyState: ${xhr.readyState}, Status: ${xhr.status}`, 'info');
                
                if (xhr.readyState === 4) {
                    if (xhr.status === 200) {
                        try {
                            const data = JSON.parse(xhr.responseText);
                            log(`Success! Data keys: ${Object.keys(data).join(', ')}`, 'success');
                        } catch (e) {
                            log(`Parse Error: ${e.message}`, 'error');
                        }
                    } else {
                        log(`Request failed with status: ${xhr.status}`, 'error');
                    }
                }
            };
            
            xhr.onerror = function() {
                log('XMLHttpRequest Error occurred', 'error');
                log(`Status: ${xhr.status}`, 'error');
                log(`StatusText: ${xhr.statusText}`, 'error');
            };
            
            xhr.open('GET', url, true);
            xhr.setRequestHeader('Accept', 'application/json');
            xhr.send();
        }

        async function testAll() {
            clearLog();
            log('===== STARTING COMPREHENSIVE TESTS =====', 'warn');
            
            // Test browser info
            log('===== BROWSER INFO =====', 'info');
            log(`User Agent: ${navigator.userAgent}`, 'info');
            log(`Online: ${navigator.onLine}`, 'info');
            log(`Current URL: ${window.location.href}`, 'info');
            log(`Protocol: ${window.location.protocol}`, 'info');
            log(`Host: ${window.location.host}`, 'info');
            
            // Test network
            log('===== NETWORK TEST =====', 'info');
            if ('connection' in navigator) {
                log(`Connection Type: ${navigator.connection.effectiveType}`, 'info');
                log(`Downlink: ${navigator.connection.downlink} Mbps`, 'info');
            }
            
            // Run all tests
            await testRelative();
            await new Promise(r => setTimeout(r, 1000));
            
            await testDirect();
            await new Promise(r => setTimeout(r, 1000));
            
            await testXHR();
            
            log('===== ALL TESTS COMPLETED =====', 'warn');
        }

        // Auto-run tests on load
        window.onload = function() {
            log('Page loaded, starting tests...', 'warn');
            testAll();
        };
    </script>
    <script>
    if ("serviceWorker" in navigator) {
        navigator.serviceWorker.register("/client/public/service-worker.js")
            .then(reg => console.log("Service Worker registered"))
            .catch(err => console.log("Service Worker registration failed"));
    }
    </script>
</body>
</html>